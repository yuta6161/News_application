# RSS自動収集ワークフロー
# 1時間に1回RSS収集を実行します

name: 🌐 RSS Auto Collection

on:
  schedule:
    # 1時間に1回実行（UTC時間）
    # 日本時間で考える場合は -9時間で計算
    - cron: '0 * * * *'
  
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      force_run:
        description: '強制実行'
        required: false
        default: 'false'

jobs:
  collect-rss:
    name: 📡 RSS記事収集
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30分でタイムアウト（十分すぎる時間）
    
    steps:
    - name: 🚀 RSS収集開始
      run: |
        echo "🕐 RSS収集を開始します: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🔗 対象URL: ${{ secrets.RSS_COLLECTION_URL }}"
    
    - name: 📡 RSS収集実行
      id: rss_collection
      run: |
        # RSS収集API呼び出し
        response=$(curl -X GET "${{ secrets.RSS_COLLECTION_URL }}/api/cron" \
          -H "Content-Type: application/json" \
          -w "HTTPSTATUS:%{http_code}" \
          --max-time 600 \
          --retry 3 \
          --retry-delay 10 \
          --silent)
        
        # HTTPステータスコードを抽出
        http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
        
        echo "📊 HTTPステータス: $http_code"
        
        if [ $http_code -eq 200 ]; then
          echo "✅ RSS収集成功"
          echo "📄 レスポンス: $body"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "❌ RSS収集失敗 (HTTP: $http_code)"
          echo "📄 エラー内容: $body"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: 📈 収集結果サマリー
      if: steps.rss_collection.outputs.success == 'true'
      run: |
        echo "🎉 RSS収集完了!"
        echo "⏰ 完了時刻: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🔄 次回実行: 1時間後"
    
    - name: 🚨 エラー通知
      if: failure()
      run: |
        echo "❌ RSS収集に失敗しました"
        echo "🕐 失敗時刻: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "🔍 ログを確認してください"
    
    - name: 📝 実行ログ保存
      if: always()
      run: |
        echo "=== RSS収集実行ログ ===" >> execution.log
        echo "実行時刻: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> execution.log
        echo "成功: ${{ steps.rss_collection.outputs.success }}" >> execution.log
        echo "========================" >> execution.log
        cat execution.log