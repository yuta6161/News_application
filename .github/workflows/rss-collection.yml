# RSSè‡ªå‹•åŽé›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# 1æ™‚é–“ã«1å›žRSSåŽé›†ã‚’å®Ÿè¡Œã—ã¾ã™

name: ðŸŒ RSS Auto Collection

on:
  schedule:
    # 1æ™‚é–“ã«1å›žå®Ÿè¡Œï¼ˆUTCæ™‚é–“ï¼‰
    # æ—¥æœ¬æ™‚é–“ã§è€ƒãˆã‚‹å ´åˆã¯ -9æ™‚é–“ã§è¨ˆç®—
    - cron: '0 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: 'false'

jobs:
  collect-rss:
    name: ðŸ“¡ RSSè¨˜äº‹åŽé›†
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆååˆ†ã™ãŽã‚‹æ™‚é–“ï¼‰
    
    steps:
    - name: ðŸš€ RSSåŽé›†é–‹å§‹
      run: |
        echo "ðŸ• RSSåŽé›†ã‚’é–‹å§‹ã—ã¾ã™: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ”— å¯¾è±¡URL: ${{ secrets.RSS_COLLECTION_URL }}"
    
    - name: ðŸ“¡ RSSåŽé›†å®Ÿè¡Œ
      id: rss_collection
      run: |
        # RSSåŽé›†APIå‘¼ã³å‡ºã—
        response=$(curl -X GET "${{ secrets.RSS_COLLECTION_URL }}/api/cron" \
          -H "Content-Type: application/json" \
          -w "HTTPSTATUS:%{http_code}" \
          --max-time 600 \
          --retry 3 \
          --retry-delay 10 \
          --silent)
        
        # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
        
        echo "ðŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
        
        if [ $http_code -eq 200 ]; then
          echo "âœ… RSSåŽé›†æˆåŠŸ"
          echo "ðŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $body"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ RSSåŽé›†å¤±æ•— (HTTP: $http_code)"
          echo "ðŸ“„ ã‚¨ãƒ©ãƒ¼å†…å®¹: $body"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ðŸ“ˆ åŽé›†çµæžœã‚µãƒžãƒªãƒ¼
      if: steps.rss_collection.outputs.success == 'true'
      run: |
        echo "ðŸŽ‰ RSSåŽé›†å®Œäº†!"
        echo "â° å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ”„ æ¬¡å›žå®Ÿè¡Œ: 1æ™‚é–“å¾Œ"
    
    - name: ðŸš¨ ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ RSSåŽé›†ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "ðŸ• å¤±æ•—æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    
    - name: ðŸ“ å®Ÿè¡Œãƒ­ã‚°ä¿å­˜
      if: always()
      run: |
        echo "=== RSSåŽé›†å®Ÿè¡Œãƒ­ã‚° ===" >> execution.log
        echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> execution.log
        echo "æˆåŠŸ: ${{ steps.rss_collection.outputs.success }}" >> execution.log
        echo "========================" >> execution.log
        cat execution.log