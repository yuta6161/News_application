# RSSåé›†ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ï¼ˆè¨­å®šç¢ºèªç”¨ï¼‰

name: ğŸ§ª RSS Collection Test

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'quick'
        type: choice
        options:
        - quick
        - full

jobs:
  test-rss:
    name: ğŸ§ª RSSåé›†ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸš€ ãƒ†ã‚¹ãƒˆé–‹å§‹
      run: |
        echo "ğŸ§ª RSSåé›†ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™"
        echo "ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ¯ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode }}"
    
    - name: ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆ
      run: |
        echo "ğŸ” ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­..."
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
        if curl -f -s "${{ secrets.RSS_COLLECTION_URL }}" > /dev/null; then
          echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å¸¸ã«å‹•ä½œä¸­"
        else
          echo "âš ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¥ç¶šã§ãã¾ã›ã‚“"
          echo "ğŸ”— URL: ${{ secrets.RSS_COLLECTION_URL }}"
        fi
    
    - name: ğŸ“¡ RSSåé›†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ“¡ RSSåé›†APIã‚’ãƒ†ã‚¹ãƒˆä¸­..."
        
        response=$(curl -X GET "${{ secrets.RSS_COLLECTION_URL }}/api/cron" \
          -H "Content-Type: application/json" \
          -w "HTTPSTATUS:%{http_code}" \
          --max-time 300 \
          --silent)
        
        http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
        
        if [ $http_code -eq 200 ]; then
          echo "âœ… RSSåé›†ãƒ†ã‚¹ãƒˆæˆåŠŸ!"
          echo "ğŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
        else
          echo "âŒ RSSåé›†ãƒ†ã‚¹ãƒˆå¤±æ•—"
          echo "ğŸ“Š HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
          echo "ğŸ“„ ã‚¨ãƒ©ãƒ¼å†…å®¹: $body"
        fi
    
    - name: ğŸ‰ ãƒ†ã‚¹ãƒˆå®Œäº†
      run: |
        echo "ğŸ‰ RSSåé›†ãƒ†ã‚¹ãƒˆå®Œäº†!"
        echo "â° å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"