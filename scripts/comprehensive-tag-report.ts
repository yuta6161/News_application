import { config } from 'dotenv';
import { supabase } from '../lib/supabase';
import { writeFileSync } from 'fs';
import { join } from 'path';

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
config({ path: '.env.local' });

interface TagAnalysis {
  tag_name: string;
  category: string;
  usage_count: number;
  confidence_avg: number;
  is_auto_generated: boolean;
  first_used: string;
  last_used: string;
  sample_articles: Array<{
    title: string;
    source_name: string;
    confidence_score: number;
  }>;
}

async function generateComprehensiveTagReport() {
  console.log('ğŸ” åŒ…æ‹¬çš„ã‚¿ã‚°åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...\n');

  try {
    // 1. å…¨ã‚¿ã‚°ä½¿ç”¨çŠ¶æ³ã®å–å¾—ï¼ˆäº‹å‰å®šç¾© + è‡ªå‹•ç”Ÿæˆï¼‰
    console.log('ğŸ“Š ã‚¿ã‚°ä½¿ç”¨çŠ¶æ³ã‚’åˆ†æä¸­...');
    
    const { data: tagUsageData, error: tagError } = await supabase
      .from('article_tags')
      .select(`
        tag_name,
        category,
        is_auto_generated,
        confidence_score,
        created_at,
        news_articles!inner (
          title,
          source_name
        )
      `)
      .order('created_at', { ascending: false });

    if (tagError) {
      console.error('âŒ ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', tagError);
      return;
    }

    // 2. äº‹å‰å®šç¾©ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ¼ã®å–å¾—
    const { data: masterTags, error: masterError } = await supabase
      .from('tag_master')
      .select('tag_name, category, base_reliability')
      .order('base_reliability', { ascending: false });

    if (masterError) {
      console.error('âŒ ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', masterError);
      return;
    }

    console.log(`   å–å¾—å®Œäº†: ${tagUsageData?.length || 0} ä»¶ã®ã‚¿ã‚°ä½¿ç”¨å±¥æ­´`);
    console.log(`   äº‹å‰å®šç¾©ã‚¿ã‚°: ${masterTags?.length || 0} ä»¶\n`);

    // 3. ã‚¿ã‚°åˆ¥çµ±è¨ˆã®è¨ˆç®—
    const tagStats: { [key: string]: TagAnalysis } = {};
    
    tagUsageData?.forEach(usage => {
      const key = `${usage.tag_name}_${usage.category}_${usage.is_auto_generated}`;
      
      if (!tagStats[key]) {
        tagStats[key] = {
          tag_name: usage.tag_name,
          category: usage.category,
          usage_count: 0,
          confidence_avg: 0,
          is_auto_generated: usage.is_auto_generated,
          first_used: usage.created_at,
          last_used: usage.created_at,
          sample_articles: []
        };
      }
      
      const stats = tagStats[key];
      stats.usage_count++;
      stats.confidence_avg = (stats.confidence_avg * (stats.usage_count - 1) + usage.confidence_score) / stats.usage_count;
      
      if (usage.created_at < stats.first_used) stats.first_used = usage.created_at;
      if (usage.created_at > stats.last_used) stats.last_used = usage.created_at;
      
      if (stats.sample_articles.length < 3) {
        stats.sample_articles.push({
          title: usage.news_articles.title,
          source_name: usage.news_articles.source_name,
          confidence_score: usage.confidence_score
        });
      }
    });

    const analysisResults = Object.values(tagStats);
    
    // 4. è¨˜äº‹çµ±è¨ˆã®å–å¾—
    const { data: articleStats, error: articleError } = await supabase
      .from('news_articles')
      .select('id, title, ai_summary, importance_score, created_at')
      .order('created_at', { ascending: false });

    if (articleError) {
      console.error('âŒ è¨˜äº‹çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', articleError);
      return;
    }

    // 5. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
    const reportPath = join(process.cwd(), 'reports', `comprehensive-tag-report-${timestamp}.md`);
    
    const report = generateReportMarkdown(analysisResults, masterTags || [], articleStats || []);
    
    // 6. ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
    writeFileSync(reportPath, report, 'utf8');
    console.log(`âœ… ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: ${reportPath}\n`);
    
    // 7. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚µãƒãƒªãƒ¼
    printConsoleSummary(analysisResults, masterTags || [], articleStats || []);
    
  } catch (error) {
    console.error('âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
  }
}

function generateReportMarkdown(
  tagAnalyses: TagAnalysis[],
  masterTags: any[],
  articles: any[]
): string {
  const timestamp = new Date().toLocaleString('ja-JP');
  const aiAnalyzedCount = articles.filter(a => a.ai_summary).length;
  
  // ä½¿ç”¨é »åº¦ã§ã‚½ãƒ¼ãƒˆ
  const sortedTags = tagAnalyses.sort((a, b) => b.usage_count - a.usage_count);
  const predefinedUsed = sortedTags.filter(t => !t.is_auto_generated);
  const autoGenerated = sortedTags.filter(t => t.is_auto_generated);
  
  // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ
  const categoryStats: { [key: string]: number } = {};
  sortedTags.forEach(tag => {
    categoryStats[tag.category] = (categoryStats[tag.category] || 0) + tag.usage_count;
  });

  return `# åŒ…æ‹¬çš„ã‚¿ã‚°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ç”Ÿæˆæ—¥æ™‚**: ${timestamp}  
**åˆ†æå¯¾è±¡**: äº‹å‰å®šç¾©ã‚¿ã‚° + è‡ªå‹•ç”Ÿæˆã‚¿ã‚°

## ğŸ“Š å…¨ä½“çµ±è¨ˆ

| é …ç›® | æ•°å€¤ |
|------|------|
| ç·è¨˜äº‹æ•° | ${articles.length} ä»¶ |
| AIåˆ†ææ¸ˆè¨˜äº‹ | ${aiAnalyzedCount} ä»¶ |
| äº‹å‰å®šç¾©ã‚¿ã‚°æ•° | ${masterTags.length} ä»¶ |
| ä½¿ç”¨ä¸­ã®äº‹å‰å®šç¾©ã‚¿ã‚° | ${predefinedUsed.length} ä»¶ |
| è‡ªå‹•ç”Ÿæˆã‚¿ã‚°æ•° | ${autoGenerated.length} ä»¶ |
| ç·ã‚¿ã‚°ä½¿ç”¨å›æ•° | ${sortedTags.reduce((sum, t) => sum + t.usage_count, 0)} å› |

## ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªåˆ¥ä½¿ç”¨çŠ¶æ³

| ã‚«ãƒ†ã‚´ãƒª | ä½¿ç”¨å›æ•° | å‰²åˆ |
|----------|----------|------|
${Object.entries(categoryStats)
  .sort((a, b) => b[1] - a[1])
  .map(([category, count]) => {
    const percentage = ((count / sortedTags.reduce((sum, t) => sum + t.usage_count, 0)) * 100).toFixed(1);
    return `| ${category} | ${count} å› | ${percentage}% |`;
  })
  .join('\n')}

## ğŸ† ä½¿ç”¨é »åº¦TOP10ï¼ˆå…¨ã‚¿ã‚°ï¼‰

| é †ä½ | ã‚¿ã‚°å | ã‚«ãƒ†ã‚´ãƒª | ä½¿ç”¨å›æ•° | å¹³å‡ä¿¡é ¼åº¦ | ã‚¿ã‚¤ãƒ— |
|------|--------|----------|----------|------------|--------|
${sortedTags.slice(0, 10).map((tag, index) => {
  const type = tag.is_auto_generated ? 'ğŸ”„è‡ªå‹•ç”Ÿæˆ' : 'ğŸ“Œäº‹å‰å®šç¾©';
  return `| ${index + 1} | ${tag.tag_name} | ${tag.category} | ${tag.usage_count} | ${tag.confidence_avg.toFixed(2)} | ${type} |`;
}).join('\n')}

## ğŸ“Œ äº‹å‰å®šç¾©ã‚¿ã‚°ã®ä½¿ç”¨çŠ¶æ³

### ä½¿ç”¨ä¸­ã®äº‹å‰å®šç¾©ã‚¿ã‚° (${predefinedUsed.length}ä»¶)

${predefinedUsed.length > 0 ? predefinedUsed.map(tag => `
#### ${tag.tag_name} (${tag.category})
- **ä½¿ç”¨å›æ•°**: ${tag.usage_count} å›
- **å¹³å‡ä¿¡é ¼åº¦**: ${tag.confidence_avg.toFixed(2)}
- **åˆå›ä½¿ç”¨**: ${new Date(tag.first_used).toLocaleDateString('ja-JP')}
- **æœ€çµ‚ä½¿ç”¨**: ${new Date(tag.last_used).toLocaleDateString('ja-JP')}
- **ã‚µãƒ³ãƒ—ãƒ«è¨˜äº‹**:
${tag.sample_articles.map(article => `  - "${article.title.substring(0, 50)}..." (${article.source_name}, ä¿¡é ¼åº¦: ${article.confidence_score})`).join('\n')}
`).join('\n') : 'ä½¿ç”¨ä¸­ã®äº‹å‰å®šç¾©ã‚¿ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### æœªä½¿ç”¨ã®äº‹å‰å®šç¾©ã‚¿ã‚°

${masterTags.filter(master => !predefinedUsed.some(used => used.tag_name === master.tag_name)).map(tag => 
  `- ${tag.tag_name} (${tag.category}, åŸºæœ¬ä¿¡é ¼åº¦: ${tag.base_reliability})`
).join('\n')}

## ğŸ”„ è‡ªå‹•ç”Ÿæˆã‚¿ã‚° (${autoGenerated.length}ä»¶)

${autoGenerated.length > 0 ? autoGenerated.map(tag => `
#### ${tag.tag_name} (${tag.category})
- **ä½¿ç”¨å›æ•°**: ${tag.usage_count} å›
- **å¹³å‡ä¿¡é ¼åº¦**: ${tag.confidence_avg.toFixed(2)}
- **åˆå›ç”Ÿæˆ**: ${new Date(tag.first_used).toLocaleDateString('ja-JP')}
- **æœ€çµ‚ä½¿ç”¨**: ${new Date(tag.last_used).toLocaleDateString('ja-JP')}
- **ã‚µãƒ³ãƒ—ãƒ«è¨˜äº‹**:
${tag.sample_articles.map(article => `  - "${article.title.substring(0, 50)}..." (${article.source_name}, ä¿¡é ¼åº¦: ${article.confidence_score})`).join('\n')}
`).join('\n') : 'è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

## ğŸ’¡ æ¨å¥¨äº‹é …

### é«˜ä¾¡å€¤è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ï¼ˆäº‹å‰å®šç¾©å€™è£œï¼‰
${autoGenerated.filter(tag => tag.usage_count >= 2 && tag.confidence_avg >= 0.8).map(tag => 
  `- **${tag.tag_name}** (${tag.category}): ${tag.usage_count}å›ä½¿ç”¨, å¹³å‡ä¿¡é ¼åº¦${tag.confidence_avg.toFixed(2)}`
).join('\n') || 'è©²å½“ãªã—'}

### æ´»ç”¨åº¦ã®ä½ã„äº‹å‰å®šç¾©ã‚¿ã‚°
${masterTags.filter(master => {
  const used = predefinedUsed.find(u => u.tag_name === master.tag_name);
  return !used || used.usage_count <= 1;
}).slice(0, 5).map(tag => `- ${tag.tag_name} (${tag.category})`).join('\n')}

---
*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ Gemini 2.5 Flash ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚°åˆ†æçµæœã§ã™*
`;
}

function printConsoleSummary(
  tagAnalyses: TagAnalysis[],
  masterTags: any[],
  articles: any[]
) {
  const sortedTags = tagAnalyses.sort((a, b) => b.usage_count - a.usage_count);
  const predefinedUsed = sortedTags.filter(t => !t.is_auto_generated);
  const autoGenerated = sortedTags.filter(t => t.is_auto_generated);
  const aiAnalyzedCount = articles.filter(a => a.ai_summary).length;
  
  console.log('ğŸ‰ ===== åŒ…æ‹¬çš„ã‚¿ã‚°åˆ†æã‚µãƒãƒªãƒ¼ =====');
  console.log(`ğŸ“Š ç·è¨˜äº‹æ•°: ${articles.length} (AIåˆ†ææ¸ˆã¿: ${aiAnalyzedCount})`);
  console.log(`ğŸ“Œ äº‹å‰å®šç¾©ã‚¿ã‚°: ${masterTags.length} å€‹ä¸­ ${predefinedUsed.length} å€‹ä½¿ç”¨ä¸­`);
  console.log(`ğŸ”„ è‡ªå‹•ç”Ÿæˆã‚¿ã‚°: ${autoGenerated.length} å€‹`);
  console.log(`ğŸ’¯ ç·ã‚¿ã‚°ä½¿ç”¨å›æ•°: ${sortedTags.reduce((sum, t) => sum + t.usage_count, 0)} å›\n`);
  
  console.log('ğŸ† TOP10 ä½¿ç”¨é »åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°:');
  sortedTags.slice(0, 10).forEach((tag, index) => {
    const type = tag.is_auto_generated ? 'ğŸ”„' : 'ğŸ“Œ';
    console.log(`${index + 1}. ${type} ${tag.tag_name} (${tag.usage_count}å›, ä¿¡é ¼åº¦: ${tag.confidence_avg.toFixed(2)})`);
  });
  
  if (autoGenerated.length > 0) {
    console.log('\nğŸ’¡ æ³¨ç›®ã®è‡ªå‹•ç”Ÿæˆã‚¿ã‚°:');
    autoGenerated.filter(t => t.usage_count >= 2).slice(0, 5).forEach(tag => {
      console.log(`   ğŸ”¸ ${tag.tag_name}: ${tag.usage_count}å›ä½¿ç”¨ (ä¿¡é ¼åº¦: ${tag.confidence_avg.toFixed(2)})`);
    });
  }
}

// ç›´æ¥å®Ÿè¡Œæ™‚
if (require.main === module) {
  generateComprehensiveTagReport()
    .then(() => {
      console.log('\nâœ… åŒ…æ‹¬çš„ã‚¿ã‚°åˆ†æå®Œäº†');
      process.exit(0);
    })
    .catch(error => {
      console.error('âŒ åˆ†æã‚¨ãƒ©ãƒ¼:', error);
      process.exit(1);
    });
}

export { generateComprehensiveTagReport };