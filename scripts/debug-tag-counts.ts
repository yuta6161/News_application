import { supabase } from '@/lib/supabase'

async function debugTagCounts() {
  console.log('ğŸ” ã‚¿ã‚°ã‚«ã‚¦ãƒ³ãƒˆè©³ç´°ãƒ‡ãƒãƒƒã‚°...\n')
  
  // 1. å…¨ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆUIã¨åŒã˜ã‚¯ã‚¨ãƒªï¼‰
  const { data: allTags, error: tagsError } = await supabase
    .from('article_tags')
    .select('tag_name, category, confidence_score, is_auto_generated')
  
  if (tagsError) {
    console.error('âŒ ã‚¿ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', tagsError)
    return
  }

  console.log('ğŸ“Š ç”Ÿãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:')
  console.log('   ç·ã‚¿ã‚°ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:', allTags?.length || 0)
  
  if (!allTags || allTags.length === 0) {
    console.log('âŒ ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ãªã—')
    return
  }

  // 2. ã‚¿ã‚°ã”ã¨ã«é›†è¨ˆï¼ˆUIã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
  const tagStats: { [key: string]: any } = {}
  
  allTags.forEach(tag => {
    if (!tagStats[tag.tag_name]) {
      tagStats[tag.tag_name] = {
        tag_name: tag.tag_name,
        total_usage: 0,
        is_auto_generated: tag.is_auto_generated,
        category: tag.category,
        avg_confidence: 0
      }
    }
    
    tagStats[tag.tag_name].total_usage++
    tagStats[tag.tag_name].avg_confidence += tag.confidence_score
  })

  // 3. å¹³å‡ä¿¡é ¼åº¦ã‚’ç®—å‡ºã—ã€é…åˆ—ã«å¤‰æ›
  const summaries = Object.values(tagStats).map((stat: any) => ({
    ...stat,
    avg_confidence: stat.avg_confidence / stat.total_usage
  }))

  // 4. ã‚½ãƒ¼ãƒˆï¼ˆUIã¨åŒã˜ï¼‰
  summaries.sort((a: any, b: any) => {
    if (a.is_auto_generated !== b.is_auto_generated) {
      return a.is_auto_generated ? 1 : -1 // äº‹å‰å®šç¾©ã‚’ä¸Šä½ã«
    }
    return b.total_usage - a.total_usage // ä½¿ç”¨é »åº¦é †
  })

  console.log('ğŸ“‹ é›†è¨ˆçµæœ:')
  console.log('   ç·ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¿ã‚°æ•°:', summaries.length)
  
  const predefinedCount = summaries.filter((s: any) => !s.is_auto_generated).length
  const autoCount = summaries.filter((s: any) => s.is_auto_generated).length
  
  console.log('   ğŸ“Œ äº‹å‰å®šç¾©ã‚¿ã‚°ç¨®é¡:', predefinedCount)
  console.log('   ğŸ”„ è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ç¨®é¡:', autoCount)
  
  console.log('\nğŸ·ï¸ äº‹å‰å®šç¾©ã‚¿ã‚°è©³ç´°:')
  summaries
    .filter((s: any) => !s.is_auto_generated)
    .forEach((tag: any, index) => {
      console.log(`   ${index + 1}. ${tag.tag_name} (ä½¿ç”¨${tag.total_usage}å›, ä¿¡é ¼åº¦${(tag.avg_confidence * 100).toFixed(0)}%)`)
    })
  
  console.log('\nğŸ”„ è‡ªå‹•ç”Ÿæˆã‚¿ã‚° Top 10:')
  summaries
    .filter((s: any) => s.is_auto_generated)
    .slice(0, 10)
    .forEach((tag: any, index) => {
      console.log(`   ${index + 1}. ${tag.tag_name} (ä½¿ç”¨${tag.total_usage}å›, ä¿¡é ¼åº¦${(tag.avg_confidence * 100).toFixed(0)}%)`)
    })
    
  // 5. ç·ã‚¿ã‚°ä½¿ç”¨æ•°è¨ˆç®—
  const totalUsage = summaries.reduce((sum, tag: any) => sum + tag.total_usage, 0)
  console.log('\nğŸ“Š ç·ä½¿ç”¨å›æ•°:', totalUsage)
  
  // 6. ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  console.log('\nğŸ§® æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯:')
  console.log(`   ç”Ÿãƒ‡ãƒ¼ã‚¿ä»¶æ•° (${allTags.length}) === ç·ä½¿ç”¨å›æ•° (${totalUsage}):`, allTags.length === totalUsage ? 'âœ…' : 'âŒ')
  console.log(`   äº‹å‰å®šç¾© + è‡ªå‹•ç”Ÿæˆ (${predefinedCount + autoCount}) === ç·ãƒ¦ãƒ‹ãƒ¼ã‚¯ (${summaries.length}):`, (predefinedCount + autoCount) === summaries.length ? 'âœ…' : 'âŒ')
  
  // 7. ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã•ã‚Œã‚‹æ•°å€¤ã¨æ¯”è¼ƒ
  console.log('\nğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºã¨ã®æ¯”è¼ƒ:')
  console.log(`   ğŸ“Œ äº‹å‰å®šç¾©ã‚¿ã‚°: DB${predefinedCount} vs è¡¨ç¤º5 â†’ ${predefinedCount === 5 ? 'âœ…' : 'âŒä¸ä¸€è‡´'}`)
  console.log(`   ğŸ”„ è‡ªå‹•ç”Ÿæˆã‚¿ã‚°: DB${autoCount} vs è¡¨ç¤º224 â†’ ${autoCount === 224 ? 'âœ…' : 'âŒä¸ä¸€è‡´'}`)
  
  // 8. å¯èƒ½æ€§ã®ã‚ã‚‹åŸå› èª¿æŸ»
  if (predefinedCount !== 5 || autoCount !== 224) {
    console.log('\nğŸ” ä¸ä¸€è‡´ã®åŸå› èª¿æŸ»:')
    
    // null/undefinedå€¤ã®ãƒã‚§ãƒƒã‚¯
    const nullAutoGenerated = allTags.filter(t => t.is_auto_generated === null || t.is_auto_generated === undefined)
    console.log(`   null/undefined is_auto_generated: ${nullAutoGenerated.length}ä»¶`)
    
    if (nullAutoGenerated.length > 0) {
      console.log('   ã‚µãƒ³ãƒ—ãƒ«:', nullAutoGenerated.slice(0, 3).map(t => t.tag_name))
    }
    
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const duplicates = allTags.filter((tag, index, arr) => 
      arr.findIndex(t => t.tag_name === tag.tag_name && t.is_auto_generated === tag.is_auto_generated) !== index
    )
    console.log(`   é‡è¤‡ã‚¿ã‚°: ${duplicates.length}ä»¶`)
  }
}

// å®Ÿè¡Œ
debugTagCounts().catch(console.error)